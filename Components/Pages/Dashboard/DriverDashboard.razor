@page "/dashboard/driver"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using t12Project.Components.Shared
@using t12Project.Models
@attribute [Authorize (Roles = "Driver")]

<PageTitle>Driver Dashboard - LoadHitch</PageTitle>

<DashboardLayout>
    <DashboardHeader 
        Label="Driver area" 
        LabelColor="text-hitchBlue"
        Title="Driver dashboard"
        Subtitle="Browse available loads below." />

    <!-- Table now supports row click -->
    <DashboardTable Headers="loadHeaders" Items="loadItems" BaseUrl="/booking/load" />


    <!-- MapView now uses tuple-based pins -->
    <MapView Loads="loadPins" UserLocation="driverLocation" />
</DashboardLayout>

@code {
    [Inject] private ApplicationDbContext Context { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;

    private List<string> loadHeaders = new() { "Load ID", "Pickup", "Dropoff", "Status", "Description" };
    private List<List<string>> loadItems = new();
    private List<(double lat, double lng, string label)> loadPins = new();
    private (double lat, double lng) driverLocation;

    protected override void OnInitialized()
    {
        var loads = Context.Loads
            .Select(l => new
            {
                l.Id,
                l.PickupLocation,
                l.DropoffLocation,
                l.Status,
                l.Description,
                l.Title,
                l.CustomerId
            })
            .ToList();

        loadItems = loads
            .Select(l => new List<string>
            {
                l.Id.ToString(),
                l.PickupLocation,
                l.DropoffLocation,
                l.Status,
                l.Description
            })
            .ToList();

        var customerPins = Context.CustomerLocationUpdates
            .OrderByDescending(c => c.ReportedAt)
            .ToList();

        loadPins = customerPins
            .Select(c => ((double)c.Latitude, (double)c.Longitude, $"Customer {c.CustomerId} - {c.Notes ?? "Load"}"))
            .ToList();

        var driverUpdate = Context.LocationUpdates
            .OrderByDescending(u => u.ReportedAt)
            .FirstOrDefault();

        driverLocation = driverUpdate != null
            ? ((double)driverUpdate.Latitude, (double)driverUpdate.Longitude)
            : (-26.320, 31.150);
    }

    private void HandleLoadClick(List<string> row)
    {
        var loadId = row[0]; // first cell is Load ID
        NavManager.NavigateTo($"/booking/load/{loadId}");
    }
}
