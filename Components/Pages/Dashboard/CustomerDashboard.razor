@page "/dashboard/customer"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using t12Project.Components.Shared
@using t12Project.Models
@attribute [Authorize (Roles = "Customer")]

<PageTitle>Customer Dashboard - LoadHitch</PageTitle>

<DashboardLayout>
    <DashboardHeader 
        Label="Customer area" 
        LabelColor="text-hitchOrange"
        Title="Customer dashboard"
        Subtitle="Browse available trucks below." />

    <!-- Table now supports row click -->
    <DashboardTable Headers="truckHeaders" Items="truckItems" BaseUrl="/booking/truck" />


    <!-- MapView now uses tuple-based pins -->
    <MapView Trucks="truckPins" UserLocation="customerLocation" />
</DashboardLayout>

@code {
    [Inject] private ApplicationDbContext Context { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;

    private List<string> truckHeaders = new() { "Truck ID", "Name", "Equipment Type", "Capacity (lbs)", "Active" };
    private List<List<string>> truckItems = new();
    private List<(double lat, double lng, string label)> truckPins = new();
    private (double lat, double lng) customerLocation = (-26.305, 31.136);

    protected override void OnInitialized()
    {
        var trucks = Context.Trucks
            .Select(t => new
            {
                t.Id,
                t.Name,
                t.EquipmentType,
                t.CapacityLbs,
                t.IsActive
            })
            .ToList();

        truckItems = trucks
            .Select(t => new List<string>
            {
                t.Id.ToString(),
                t.Name,
                t.EquipmentType,
                t.CapacityLbs.ToString("N0"),
                t.IsActive ? "Yes" : "No"
            })
            .ToList();

        truckPins = trucks
            .Select(t => (-26.320, 31.150, $"Truck {t.Name} - {(t.IsActive ? "Active" : "Inactive")}"))
            .ToList();
    }

    private void HandleTruckClick(List<string> row)
    {
        var truckId = row[0]; // first cell is Truck ID
        NavManager.NavigateTo($"/booking/truck/{truckId}");
    }
}
