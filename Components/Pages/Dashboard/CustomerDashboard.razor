@page "/dashboard/customer"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using t12Project.Components.Shared
@using t12Project.Models
@attribute [Authorize (Roles = "Customer")]

<PageTitle>Customer Dashboard - LoadHitch</PageTitle>

<DashboardLayout>
    <DashboardHeader 
        Label="Customer area" 
        LabelColor="text-hitchOrange"
        Title="Customer dashboard"
        Subtitle="Browse available trucks below." />

    <!-- Table shows string-based truck data -->
    <DashboardTable Headers="truckHeaders" Items="truckItems" />

    <!-- MapView now uses tuple-based pins -->
    <MapView Trucks="truckPins" UserLocation="customerLocation" />
</DashboardLayout>

@code {
    // Inject DbContext via DI
    [Inject] private ApplicationDbContext Context { get; set; } = default!;

    // Table headers (matching Truck model)
    private List<string> truckHeaders = new() { "Truck ID", "Name", "Equipment Type", "Capacity (lbs)", "Active" };

    // Table rows (string-based for DashboardTable)
    private List<List<string>> truckItems = new();

    // Map pins (tuple-based for MapView)
    private List<(double lat, double lng, string label)> truckPins = new();

    // Customer location (center of map)
    private (double lat, double lng) customerLocation = (-26.305, 31.136); // placeholder coords

    protected override void OnInitialized()
    {
        var trucks = Context.Trucks
            .Select(t => new
            {
                t.Id,
                t.Name,
                t.EquipmentType,
                t.CapacityLbs,
                t.IsActive
            })
            .ToList();

        // Populate table rows
        truckItems = trucks
            .Select(t => new List<string>
            {
                t.Id.ToString(),
                t.Name,
                t.EquipmentType,
                t.CapacityLbs.ToString("N0"),
                t.IsActive ? "Yes" : "No"
            })
            .ToList();

        // Map pins (placeholder until Truck has lat/lng fields)
        truckPins = trucks
            .Select(t => (-26.320, 31.150, $"Truck {t.Name} - {(t.IsActive ? "Active" : "Inactive")}"))
            .ToList();
    }
}
