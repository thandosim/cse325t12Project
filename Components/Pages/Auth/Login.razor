@page "/login"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@implements IAsyncDisposable
@inject AuthClient AuthClient
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<Login> Logger

<PageTitle>Log in - LoadHitch</PageTitle>

<section class="min-h-screen bg-slate-50 py-16">
    <div class="mx-auto max-w-md px-6">
        <!-- Logo -->
        <div class="text-center mb-8">
            <a href="/" class="text-3xl font-serif italic text-teal-500">LoadHitch</a>
        </div>
        
        <!-- Login Card -->
        <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-slate-900">Welcome back</h1>
                <p class="mt-2 text-slate-600">Sign in to your account</p>
            </div>

            @if (!string.IsNullOrWhiteSpace(_banner))
            {
                <div class="mb-4 rounded-xl bg-teal-50 border border-teal-200 px-4 py-3 text-sm text-teal-700">@_banner</div>
            }

            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <div class="mb-4 rounded-xl bg-red-50 border border-red-200 px-4 py-3 text-sm text-red-700">@_error</div>
            }

            <EditForm EditContext="_editContext" OnValidSubmit="HandleLoginAsync">
                <DataAnnotationsValidator />
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Email address</label>
                        <InputText type="email" class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-slate-900 placeholder:text-slate-400 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 focus:outline-none" placeholder="you@company.com" @bind-Value="_model.Email" @bind-Value:event="oninput" />
                        <ValidationMessage For="@(() => _model.Email)" class="mt-1 text-xs text-red-600" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Password</label>
                        <InputText type="password" class="w-full rounded-lg border border-slate-300 px-4 py-2.5 text-slate-900 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 focus:outline-none" placeholder="Enter your password" @bind-Value="_model.Password" @bind-Value:event="oninput" />
                        <ValidationMessage For="@(() => _model.Password)" class="mt-1 text-xs text-red-600" />
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <InputCheckbox class="h-4 w-4 rounded border-slate-300 text-teal-500 focus:ring-teal-500" @bind-Value="_model.RememberMe" />
                            Remember me
                        </label>
                        <a href="#" class="text-sm text-teal-600 hover:text-teal-500">Forgot password?</a>
                    </div>
                </div>

                <button type="submit" class="mt-6 w-full rounded-full bg-teal-500 px-6 py-3 text-base font-medium text-white transition hover:bg-teal-600 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled="@_isSubmitting">
                    @(_isSubmitting ? "Signing in..." : "Sign in")
                </button>
            </EditForm>

            <div class="mt-6 flex items-center gap-4 text-xs uppercase tracking-wider text-slate-400">
                <span class="h-px flex-1 bg-slate-200" />
                or
                <span class="h-px flex-1 bg-slate-200" />
            </div>

            <button class="mt-4 flex w-full items-center justify-center gap-3 rounded-full border border-slate-300 bg-white px-5 py-3 text-sm font-medium text-slate-700 transition hover:bg-slate-50 disabled:bg-slate-100 disabled:cursor-not-allowed" @onclick="StartGoogleSignInAsync" disabled="@_isSubmitting">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="h-5 w-5" />
                Continue with Google
            </button>

            <p class="mt-6 text-center text-sm text-slate-600">
                Don't have an account?
                <a class="font-medium text-teal-600 hover:text-teal-500" href="/register">Sign up</a>
            </p>
        </div>
    </div>
</section>

@code {
    private readonly LoginRequest _model = new();
    private EditContext? _editContext;
    private bool _isSubmitting;
    private bool _googleBusy;
    private string? _banner;
    private string? _error;
    private DotNetObjectReference<Login>? _dotNetRef;
    private readonly JsonSerializerOptions _jsonOptions = new(JsonSerializerDefaults.Web);

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("loadhitchAuth.registerHandler", _dotNetRef);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef is not null)
        {
            await JS.InvokeVoidAsync("loadhitchAuth.unregisterHandler", _dotNetRef);
            _dotNetRef.Dispose();
        }
    }

    private async Task HandleLoginAsync()
    {
        _isSubmitting = true;
        _banner = null;
        _error = null;

        try
        {
            var result = await AuthClient.LoginAsync(new LoginRequest
            {
                Email = _model.Email,
                Password = _model.Password,
                RememberMe = _model.RememberMe
            });

            if (!result.Succeeded || result.Payload is null)
            {
                _error = result.Message;
                return;
            }

            _banner = $"Welcome back, {result.Payload.FullName}! Redirecting...";
            StateHasChanged();
            await Task.Delay(800);
            Navigation.NavigateTo(result.Payload.DashboardUrl, forceLoad: true);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task StartGoogleSignInAsync()
    {
        _error = null;
        _banner = null;
        _googleBusy = true;
        var url = Navigation.ToAbsoluteUri("api/auth/google/signin?state=login").ToString();
        await JS.InvokeVoidAsync("loadhitchAuth.startGoogleSignIn", url);
    }

    [JSInvokable]
    public async Task HandleExternalAuthMessage(string json)
    {
        ExternalAuthMessage? message = null;
        try
        {
            message = JsonSerializer.Deserialize<ExternalAuthMessage>(json, _jsonOptions);
        }
        catch
        {
            // ignore malformed payloads
        }

        if (message is null)
        {
            _googleBusy = false;
            return;
        }

        if (string.Equals(message.Type, "loadhitch:auth", StringComparison.OrdinalIgnoreCase))
        {
            var auth = message.Payload.Deserialize<AuthResponse>(_jsonOptions);
            if (auth is not null)
            {
                await AuthClient.StoreAuthAsync(auth);
                _banner = "Signed in with Google. Redirecting...";
                _error = null;
                _googleBusy = false;
                StateHasChanged();
                await Task.Delay(800);
                Navigation.NavigateTo(auth.DashboardUrl, true);
                return;
            }
        }

        if (string.Equals(message.Type, "loadhitch:auth-error", StringComparison.OrdinalIgnoreCase))
        {
            var error = message.Payload.TryGetProperty("error", out var value)
                ? value.GetString()
                : "Unable to complete Google sign-in.";
            _error = error;
        }

        _googleBusy = false;
        StateHasChanged();
    }

    private sealed class ExternalAuthMessage
    {
        public string? Type { get; set; }
        public JsonElement Payload { get; set; }
        public JsonElement? State { get; set; }
    }
}
