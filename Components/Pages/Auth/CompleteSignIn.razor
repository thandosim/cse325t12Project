@page "/auth/complete-signin"
@using Microsoft.AspNetCore.Identity
@using t12Project.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ILogger<CompleteSignIn> Logger

<PageTitle>Completing Sign In - LoadHitch</PageTitle>

<section class="min-h-screen bg-slate-50 flex items-center justify-center py-16">
    <div class="mx-auto max-w-md px-6">
        <!-- Logo -->
        <div class="text-center mb-8">
            <a href="/" class="text-3xl font-serif italic text-teal-500">LoadHitch</a>
        </div>
        
        <!-- Card -->
        <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm text-center">
            <div class="flex justify-center mb-6">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-teal-500"></div>
            </div>
            <h1 class="text-2xl font-bold text-slate-900">@_message</h1>
            <p class="mt-3 text-slate-600">Please wait while we complete your sign in.</p>
        </div>
    </div>
</section>

@code {
    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private string _message = "Completing sign in...";

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("=== CompleteSignIn: Email={Email}, ReturnUrl={ReturnUrl} ===", Email, ReturnUrl);

        if (string.IsNullOrEmpty(Email))
        {
            _message = "Invalid sign-in request";
            Logger.LogWarning("No email provided");
            return;
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user == null)
        {
            _message = "User not found";
            Logger.LogWarning("User not found: {Email}", Email);
            return;
        }

        // Sign in the user with cookie auth
        await SignInManager.SignInAsync(user, isPersistent: true);
        Logger.LogInformation("User signed in via cookie: {Email}", Email);

        // Determine redirect URL
        var roles = await UserManager.GetRolesAsync(user);
        var dashboardUrl = roles.Contains("Admin") ? "/admin" :
                          roles.Contains("Driver") ? "/dashboard/driver" :
                          roles.Contains("Customer") ? "/dashboard/customer" :
                          "/dashboard";

        var targetUrl = !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : dashboardUrl;
        Logger.LogInformation("Redirecting to: {Url}", targetUrl);

        _message = "Redirecting...";
        Navigation.NavigateTo(targetUrl, forceLoad: true);
    }
}
